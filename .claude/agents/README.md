# Solores 项目 Sub-Agents 使用指南

## 🚀 rust-expert Sub-Agent

专业的 Rust 代码生成、架构设计和性能优化专家，专门为 Solores IDL 生成器项目服务。

### 📋 配置架构 (完全内联规范)

#### 配置设计
- **Agent 配置**: `.claude/agents/rust-expert.md` - 包含完整内联规范
- **规范存档**: `.claude/shared/*.md` - 规范文件参考存档
- **内联机制**: 所有规范直接内联到子代理文件中，确保官方兼容性

#### 配置优势
- ✅ **官方兼容**: 完全符合Claude Code官方子代理规范
- ✅ **独立运行**: 子代理无需外部依赖即可执行规范
- ✅ **隔离上下文**: 每个子代理拥有独立的规范执行环境
- ✅ **完整性保证**: 规范内容完整内联，无引用失败风险

### 核心能力

#### 🔬 深度分析能力
- **LSP 集成**: 实时代码分析、符号导航、智能补全
- **Rust 生态**: crate 结构分析、依赖管理、最新文档
- **项目记忆**: 历史决策、最佳实践、错误解决方案
- **实时诊断**: 编译错误和警告监控

#### 🚀 智能生成能力
- **上下文感知**: 基于现有代码的智能生成
- **模板驱动**: Askama 模板系统深度优化
- **自动修复**: 批量编译错误智能修复
- **安全重构**: 符号重命名和代码重构

#### 🎯 Solores 专精
- **二元架构**: Anchor vs NonAnchor 优化
- **IDL 处理**: 智能格式检测和批量转换
- **质量保证**: 100% 编译成功率

## 📋 详细使用场景

### 💻 代码实现场景
**适用情况**: 需要从零编写新功能或模块

```bash
# IDL 解析器实现
使用 rust-expert 实现 Raydium IDL 解析器

# 模板系统开发  
让 rust-expert 编写新的 Askama 模板

# 错误处理模块
rust-expert 帮我实现标准的错误处理逻辑

# 账户结构解析
rust-expert 实现 Solana 账户结构解析
```

### 🎯 任务完成场景
**适用情况**: 有明确的任务目标需要完成

```bash
# 批量处理功能
使用 rust-expert 完成所有 IDL 的批量转换

# 系统重构
让 rust-expert 完成模板系统的性能优化

# 问题修复
rust-expert 完成所有编译错误的修复

# 测试编写
rust-expert 完成所有测试用例编写
```

### 🏗️ 架构设计场景
**适用情况**: 需要设计或重构系统架构

```bash
# 架构分析
使用 rust-expert 分析这个架构问题

# 性能优化
rust-expert 优化这个模板系统性能

# 模块重构
请 rust-expert 重构这个模块结构

# 架构设计
rust-expert 设计这个功能的最佳架构
```

### ✅ 质量验证流程
**自动执行**: rust-expert 完成任务后会自动进行

#### 1. 文件结构检查
- 验证目录结构符合项目规范
- 确认所有必要文件已生成 (lib.rs, Cargo.toml, README.md)
- 检查模块导入导出完整性
- 验证 Cargo.toml 配置正确性

#### 2. 代码质量验证
- 运行完整的编译检查 (`cargo check`)
- 执行功能测试验证 (`cargo test`)
- 应用代码格式化 (`cargo fmt`)
- 运行 clippy 检查 (`cargo clippy`)

#### 3. Solores 特定验证
- IDL 解析功能验证
- 生成接口 API 完整性检查
- Askama 模板渲染结果验证
- 批量处理功能测试

#### 4. 交付确认
- 提供详细的验证结果报告
- 记录解决方案到知识库
- 更新相关文档
- 确认任务 100% 完成

## 📋 使用方式

### 自动触发场景
rust-expert 会在以下情况自动激活：
- 复杂 Rust 架构设计问题
- 批量编译错误修复需求
- 模板系统优化
- 性能瓶颈诊断
- Solana 生态特定代码生成

## 🛠️ 集成工具矩阵

| 工具类别 | 具体功能 | 使用场景 |
|---------|---------|----------|
| **LSP 集成** | 符号导航、智能补全、诊断 | 实时代码分析 |
| **rust-docs** | crate 分析、依赖管理 | 深度生态理解 |
| **context7** | 最新文档检索 | 最佳实践获取 |
| **basic-memory** | 知识管理、历史记录 | 经验积累 |
| **文件操作** | Read/Write/Edit/MultiEdit | 代码修改 |

## 🎯 Solores 项目最佳实践

### 模板系统工作流
1. **分析现有模板** - 使用 LSP 理解模板结构
2. **查询最佳实践** - context7 获取 Askama 最新文档
3. **智能优化** - 基于项目特点优化模板
4. **验证效果** - 实时诊断确保生成质量

### IDL 处理工作流
1. **格式检测** - 智能识别 Anchor/NonAnchor
2. **依赖分析** - rust-docs 分析相关 crate
3. **批量生成** - 高效处理多个 IDL
4. **质量验证** - 确保 100% 编译成功

### 错误修复工作流
1. **错误收集** - 获取所有诊断信息
2. **根因分析** - 使用符号导航追踪问题
3. **历史查询** - basic-memory 查找相似问题
4. **智能修复** - 应用快速修复和重构

## 📊 质量标准

### 代码质量要求
- ✅ **零错误容忍**: 禁止 unwrap/expect
- ✅ **100% 编译率**: 所有代码必须编译通过
- ✅ **现代错误处理**: 使用 error-stack
- ✅ **参数化测试**: 强制使用 rstest
- ✅ **真实数据**: 禁止虚构测试数据

### 架构完整性
- ✅ **保持设计意图**: 禁止简化破坏
- ✅ **多文件结构**: 维护合理的模块分离
- ✅ **一致性原则**: 遵循项目编码规范

## 🔍 功能演示

### 深度分析示例
```
项目概览: 997 文件, 18193 符号
模板系统: Askama 0.12.1 集成
关键函数: should_use_askama, write_lib_with_askama
```

### 智能搜索示例
```
符号搜索: Template trait (askama crate)
方法分析: render, render_into, write_into
文档覆盖: 1456 个代码片段
```

## 🔧 配置管理

### 共享规范库
位于 `.claude/shared/` 的统一规范文件：
- `global-rules.md` - 全局强制规范和逃避行为检测
- `error-handling.md` - error-stack 优先错误处理规范  
- `performance-ban.md` - 性能测试绝对禁令
- `logging-config.md` - 文件导向日志策略
- `compilation-rules.md` - 编译错误修复禁令
- `rust-standards.md` - Rust 编程标准和 rstest 要求
- `solana-dependencies.md` - Solana 生态依赖版本管理

### 内联机制
```markdown
## 规范内容直接内联到子代理文件

# 全局规范强制执行
[完整的global-rules.md内容]

# 错误处理规范
[完整的error-handling.md内容]

# Rust编程标准
[完整的rust-standards.md内容]

[其他规范内容...]
```

### 维护指南
- **更新规范**: 修改 `.claude/shared/` 下的文件作为参考源
- **同步更新**: 手动将更新的规范内容同步到各个子代理文件
- **版本控制**: 子代理文件应纳入版本控制
- **团队同步**: 确保团队成员都有最新的子代理配置

## 🚨 注意事项

### 环境要求
- **LSP 集成**: 需要 rust-analyzer 支持
- **MCP 服务**: 确保所有 MCP 服务器正常运行
- **项目状态**: 建议在干净的 git 状态下使用
- **规范完整**: 确保子代理文件包含完整的内联规范

### 性能优化
- **缓存利用**: rust-docs 已缓存 30+ 核心 crate
- **并行处理**: 支持批量 IDL 高效转换
- **内存管理**: 智能的符号索引和搜索
- **配置完整**: 内联配置确保完整的规范执行

## 📞 获取帮助

如果 rust-expert 未按预期工作：
1. 检查 MCP 服务器状态
2. 确认项目 rust-analyzer 配置  
3. 验证 `.claude/agents/` 目录权限
4. 确认子代理文件包含完整的内联规范
5. 检查子代理文件语法正确性
6. 查看项目 CLAUDE.md 规范

### 故障排除
- **规范不生效**: 验证子代理文件中内联规范的完整性
- **配置冲突**: 确认没有重复的规范定义
- **语法错误**: 检查YAML frontmatter格式正确性

## 🎉 开始使用

创建并配置完成后，rust-expert 已经可以使用：

```bash
# 验证 agent 是否可用
/agents

# 开始使用
请 rust-expert 分析当前项目的模板系统架构
```

rust-expert 将为您的 Rust 开发提供专业、智能的支持！